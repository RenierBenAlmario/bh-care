@model Barangay.Controllers.AppointmentController.AppointmentBookingViewModel

@{
    ViewData["Title"] = "Book an Appointment";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Book an Appointment</h4>
        </div>
        <div class="card-body">
            <form method="post" id="appointmentForm" enctype="multipart/form-data" class="needs-validation" novalidate>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Patient Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="Name" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="Name" name="Name" value="@ViewBag.UserDetails.FullName" required>
                                    <div class="invalid-feedback">
                                        Please provide your full name.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="Age" class="form-label">Age</label>
                                    <input type="number" class="form-control" id="Age" name="Age" min="0" max="120" required>
                                    <div class="invalid-feedback">
                                        Please provide a valid age.
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phoneNumber" value="@ViewBag.UserDetails.PhoneNumber" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Appointment Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="DoctorId" class="form-label">Select Doctor</label>
                                    <select class="form-select" id="DoctorId" name="DoctorId" required>
                                        <option value="" selected disabled>Select a doctor</option>
                                        @foreach (var doctor in ViewBag.Doctors)
                                        {
                                            <option value="@doctor.Id">Dr. @doctor.FirstName @doctor.LastName</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a doctor.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="Date" class="form-label">Appointment Date</label>
                                    <input type="date" class="form-control" id="Date" name="Date" 
                                           min="@DateTime.Now.ToString("yyyy-MM-dd")" required>
                                    <div class="invalid-feedback">
                                        Please select a valid date.
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="Time" class="form-label">Appointment Time</label>
                                    <select class="form-select" id="Time" name="Time" required disabled>
                                        <option value="" selected disabled>Select date and doctor first</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select an appointment time.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Visit Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="Reason" class="form-label">Reason for Visit</label>
                            <textarea class="form-control" id="Reason" name="Reason" rows="3" required></textarea>
                            <div class="invalid-feedback">
                                Please provide a reason for your visit.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="attachment" class="form-label">Upload Documents (optional)</label>
                            <input type="file" class="form-control" id="attachment" name="attachment">
                            <small class="text-muted">Upload medical records, prescriptions, or other relevant documents (max 5MB)</small>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                    <label class="form-check-label" for="agreeTerms">
                        I agree to the terms and conditions and understand that I must arrive 15 minutes before my appointment.
                    </label>
                    <div class="invalid-feedback">
                        You must agree to the terms and conditions.
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">Book Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Form validation
            const form = document.getElementById('appointmentForm');
            form.addEventListener('submit', function(event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            });

            // Handle date and doctor selection to update time slots
            $('#Date, #DoctorId').change(function() {
                const date = $('#Date').val();
                const doctorId = $('#DoctorId').val();
                const timeSelect = $('#Time');

                if (date && doctorId) {
                    timeSelect.prop('disabled', true);
                    timeSelect.html('<option value="" selected disabled>Loading time slots...</option>');

                    $.get('/api/Appointment/GetAvailableTimeSlots', { doctorId: doctorId, date: date })
                        .done(function(slots) {
                            timeSelect.empty();
                            timeSelect.append('<option value="" selected disabled>Select a time slot</option>');
                            
                            if (slots && slots.length > 0) {
                                slots.forEach(function(slot) {
                                    timeSelect.append(`<option value="${slot}">${slot}</option>`);
                                });
                                timeSelect.prop('disabled', false);
                            } else {
                                timeSelect.append('<option value="" disabled>No available slots</option>');
                            }
                        })
                        .fail(function() {
                            timeSelect.html('<option value="" selected disabled>Error loading time slots</option>');
                        });
                } else {
                    timeSelect.html('<option value="" selected disabled>Select date and doctor first</option>');
                    timeSelect.prop('disabled', true);
                }
            });
        });
    </script>
} 