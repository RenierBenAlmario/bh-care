@page
@model Barangay.Pages.Admin.HEEADSSSFormManagementModel
@{
    ViewData["Title"] = "HEEADSSS Form Management";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-clipboard-list text-primary me-2"></i>
                    HEEADSSS Form Management
                </h2>
                <div class="text-muted">
                    <small>Manage and upload HEEADSSS Risk Assessment Form images for admin use only</small>
                </div>
            </div>

            <!-- Status Messages -->
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>
                        Upload New HEEADSSS Form Image
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="uploadForm" asp-page-handler="Upload">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="imageFile" class="form-label">Select Image File</label>
                                    <input type="file" class="form-control" id="imageFile" name="imageFile" accept=".jpg,.jpeg,.png" required>
                                    <div class="form-text">Max file size: 5MB. Accepted formats: JPG, PNG</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="pageNumber" class="form-label">Page Number</label>
                                    <select class="form-select" id="pageNumber" name="pageNumber" required>
                                        <option value="">-- Select Page --</option>
                                        <option value="1">Page 1 - Personal Information & Health Assessment</option>
                                        <option value="2">Page 2 - Psychosocial History & Assessment</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description (Optional)</label>
                                    <input type="text" class="form-control" id="description" name="description" placeholder="Brief description">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-warning w-100">
                                        <i class="fas fa-arrow-up me-1"></i>
                                        Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Uploaded Images Management -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-images me-2"></i>
                        Uploaded Images Management
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.UploadedImages.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Preview</th>
                                        <th>Page</th>
                                        <th>Upload Date</th>
                                        <th>File Size</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var image in Model.UploadedImages)
                                    {
                                        <tr>
                                            <td>
                                                <img src="~/uploads/heeadsss/@image.FileName" alt="HEEADSSS Form" 
                                                     class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">@image.Page</span>
                                            </td>
                                            <td>@image.UploadDate.ToString("MMM dd, yyyy HH:mm")</td>
                                            <td>@((image.FileSize / 1024.0).ToString("F1")) KB</td>
                                            <td>
                                                <span class="badge @(image.IsActive ? "bg-success" : "bg-secondary")">
                                                    @(image.IsActive ? "Active" : "Inactive")
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                                            onclick="editFormFromImage('@image.FileName', '@image.Page.Replace("Page ", "")')">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button type="button" class="btn btn-outline-warning btn-sm" 
                                                            onclick="setActiveImage('@image.FileName', '@image.Page.Replace("Page ", "")')">
                                                        <i class="fas fa-star"></i> Set Active
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                                            onclick="deleteImage('@image.FileName')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-images fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No HEEADSSS form images uploaded yet</h5>
                            <p class="text-muted">Upload your first HEEADSSS form image using the form above.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-4">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-tools me-2"></i>
                            Quick Actions
                        </h6>
                        <div class="btn-group" role="group">
                            <a href="/Admin/AdminDashboard" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Back to Dashboard
                            </a>
                            <button type="button" class="btn btn-outline-info" onclick="location.reload()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Refresh Images
                            </button>
                            <button type="button" class="btn btn-outline-success">
                                <i class="fas fa-download me-1"></i>
                                Download Active Images
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Form Modal -->
<div class="modal fade" id="editFormModal" tabindex="-1" aria-labelledby="editFormModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFormModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    Edit HEEADSSS Form Data
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Original Image</h6>
                        <img id="originalImage" src="" alt="Original Form" class="img-fluid border rounded">
                    </div>
                    <div class="col-md-6">
                        <div id="formContainer">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <p class="mt-2">Processing image...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="saveFormData">
                    <i class="fas fa-save me-1"></i>
                    Save Form Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Display -->
<div id="uploadStatus" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

<style>
.modal-xl {
    max-width: 90%;
}

.modal-body {
    max-height: 80vh;
    overflow-y: auto;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

@@media (max-width: 768px) {
    .modal-xl {
        max-width: 95%;
    }
    
    .btn-group .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>

<script>
let currentFileName = '';
let currentPageNumber = '';

function editFormFromImage(fileName, pageNumber) {
    currentFileName = fileName;
    currentPageNumber = pageNumber;
    
    // Show loading modal
    const modal = new bootstrap.Modal(document.getElementById('editFormModal'));
    modal.show();
    
    // Set original image
    document.getElementById('originalImage').src = `/uploads/heeadsss/${fileName}`;
    
    // Show loading state
    document.getElementById('formContainer').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing...</span>
            </div>
            <p class="mt-2">Processing image...</p>
        </div>
    `;
    
    // Process image
    fetch('/Admin/HEEADSSSFormManagement?handler=ProcessImageForEdit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        body: `fileName=${encodeURIComponent(fileName)}&pageNumber=${encodeURIComponent(pageNumber)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.isReadable) {
                showEditModal(fileName, pageNumber, data.data);
            } else {
                showManualEntryForm(fileName, pageNumber);
            }
        } else {
            showStatus('<i class="fas fa-exclamation-circle me-2"></i>Error processing image.', 'danger');
        }
    })
    .catch(error => {
        showStatus('<i class="fas fa-exclamation-circle me-2"></i>Error processing image.', 'danger');
    });
}

function showEditModal(fileName, pageNumber, data) {
    const formContainer = document.getElementById('formContainer');
    
    if (pageNumber === '1') {
        formContainer.innerHTML = generatePage1Form(data);
    } else if (pageNumber === '2') {
        formContainer.innerHTML = generatePage2Form(data);
    }
}

function showManualEntryForm(fileName, pageNumber) {
    const formContainer = document.getElementById('formContainer');
    
    if (pageNumber === '1') {
        formContainer.innerHTML = generatePage1Form({});
    } else if (pageNumber === '2') {
        formContainer.innerHTML = generatePage2Form({});
    }
}

function generatePage1Form(data) {
    return `
        <form id="page1Form">
            <h6 class="text-primary mb-3">Page 1 - Home & Education</h6>
            
            <!-- Health Facility Information -->
            <div class="mb-3">
                <label class="form-label">Health Facility</label>
                <input type="text" class="form-control" name="healthFacility" value="${data.healthFacility || 'Baesa Health Center'}" placeholder="Health Facility Name">
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Family Number</label>
                        <input type="text" class="form-control" name="familyNo" value="${data.familyNo || ''}" placeholder="Family Number">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="fullName" value="${data.fullName || ''}" placeholder="Full Name">
                    </div>
                </div>
            </div>
            
            <!-- Personal Information -->
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control" name="age" value="${data.age || ''}" placeholder="Age">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Gender</label>
                        <select class="form-select" name="gender">
                            <option value="">Select Gender</option>
                            <option value="M" ${data.gender === 'M' ? 'selected' : ''}>Male</option>
                            <option value="F" ${data.gender === 'F' ? 'selected' : ''}>Female</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Contact Number</label>
                        <input type="text" class="form-control" name="contactNumber" value="${data.contactNumber || ''}" placeholder="Contact Number">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea class="form-control" name="address" rows="2" placeholder="Address">${data.address || ''}</textarea>
            </div>
            
            <!-- Home Environment -->
            <h6 class="text-secondary mt-4 mb-3">Home Environment</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Home Environment</label>
                        <select class="form-select" name="homeEnvironment">
                            <option value="">Select Environment</option>
                            <option value="Stable" ${data.homeEnvironment === 'Stable' ? 'selected' : ''}>Stable</option>
                            <option value="Unstable" ${data.homeEnvironment === 'Unstable' ? 'selected' : ''}>Unstable</option>
                            <option value="Stressful" ${data.homeEnvironment === 'Stressful' ? 'selected' : ''}>Stressful</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Family Relationship</label>
                        <select class="form-select" name="familyRelationship">
                            <option value="">Select Relationship</option>
                            <option value="Good" ${data.familyRelationship === 'Good' ? 'selected' : ''}>Good</option>
                            <option value="Fair" ${data.familyRelationship === 'Fair' ? 'selected' : ''}>Fair</option>
                            <option value="Poor" ${data.familyRelationship === 'Poor' ? 'selected' : ''}>Poor</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Family Problems</label>
                <textarea class="form-control" name="homeFamilyProblems" rows="2" placeholder="Describe any family problems">${data.homeFamilyProblems || ''}</textarea>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Parental Listening</label>
                        <select class="form-select" name="homeParentalListening">
                            <option value="">Select Frequency</option>
                            <option value="Always" ${data.homeParentalListening === 'Always' ? 'selected' : ''}>Always</option>
                            <option value="Sometimes" ${data.homeParentalListening === 'Sometimes' ? 'selected' : ''}>Sometimes</option>
                            <option value="Rarely" ${data.homeParentalListening === 'Rarely' ? 'selected' : ''}>Rarely</option>
                            <option value="Never" ${data.homeParentalListening === 'Never' ? 'selected' : ''}>Never</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Parental Blame</label>
                        <select class="form-select" name="homeParentalBlame">
                            <option value="">Select Frequency</option>
                            <option value="Always" ${data.homeParentalBlame === 'Always' ? 'selected' : ''}>Always</option>
                            <option value="Sometimes" ${data.homeParentalBlame === 'Sometimes' ? 'selected' : ''}>Sometimes</option>
                            <option value="Rarely" ${data.homeParentalBlame === 'Rarely' ? 'selected' : ''}>Rarely</option>
                            <option value="Never" ${data.homeParentalBlame === 'Never' ? 'selected' : ''}>Never</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Recent Family Changes</label>
                <textarea class="form-control" name="homeFamilyChanges" rows="2" placeholder="Describe any recent family changes">${data.homeFamilyChanges || ''}</textarea>
            </div>
        </form>
    `;
}

function generatePage2Form(data) {
    return `
        <form id="page2Form">
            <h6 class="text-primary mb-3">Page 2 - Psychosocial History & Assessment</h6>
            
            <!-- Activities -->
            <h6 class="text-secondary mb-3">Activities</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Hobbies</label>
                        <input type="text" class="form-control" name="hobbies" value="${data.hobbies || ''}" placeholder="Hobbies and interests">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Physical Activity</label>
                        <select class="form-select" name="physicalActivity">
                            <option value="">Select Activity Level</option>
                            <option value="Regular" ${data.physicalActivity === 'Regular' ? 'selected' : ''}>Regular</option>
                            <option value="Moderate" ${data.physicalActivity === 'Moderate' ? 'selected' : ''}>Moderate</option>
                            <option value="Minimal" ${data.physicalActivity === 'Minimal' ? 'selected' : ''}>Minimal</option>
                            <option value="None" ${data.physicalActivity === 'None' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Screen Time</label>
                        <input type="text" class="form-control" name="screenTime" value="${data.screenTime || ''}" placeholder="Hours per day">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Activities Participation</label>
                        <select class="form-select" name="activitiesParticipation">
                            <option value="">Select Participation</option>
                            <option value="Active" ${data.activitiesParticipation === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Moderate" ${data.activitiesParticipation === 'Moderate' ? 'selected' : ''}>Moderate</option>
                            <option value="Minimal" ${data.activitiesParticipation === 'Minimal' ? 'selected' : ''}>Minimal</option>
                            <option value="None" ${data.activitiesParticipation === 'None' ? 'selected' : ''}>None</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Substance Use -->
            <h6 class="text-secondary mt-4 mb-3">Substance Use</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="substanceUse" id="substanceUse" ${data.substanceUse ? 'checked' : ''}>
                        <label class="form-check-label" for="substanceUse">Substance Use</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Substance Type</label>
                        <input type="text" class="form-control" name="substanceType" value="${data.substanceType || ''}" placeholder="Type of substance">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Tobacco Use</label>
                        <select class="form-select" name="drugsTobaccoUse">
                            <option value="">Select Usage</option>
                            <option value="No" ${data.drugsTobaccoUse === 'No' ? 'selected' : ''}>No</option>
                            <option value="Occasional" ${data.drugsTobaccoUse === 'Occasional' ? 'selected' : ''}>Occasional</option>
                            <option value="Regular" ${data.drugsTobaccoUse === 'Regular' ? 'selected' : ''}>Regular</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Alcohol Use</label>
                        <select class="form-select" name="drugsAlcoholUse">
                            <option value="">Select Usage</option>
                            <option value="No" ${data.drugsAlcoholUse === 'No' ? 'selected' : ''}>No</option>
                            <option value="Occasional" ${data.drugsAlcoholUse === 'Occasional' ? 'selected' : ''}>Occasional</option>
                            <option value="Regular" ${data.drugsAlcoholUse === 'Regular' ? 'selected' : ''}>Regular</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Illicit Drug Use</label>
                        <select class="form-select" name="drugsIllicitDrugUse">
                            <option value="">Select Usage</option>
                            <option value="No" ${data.drugsIllicitDrugUse === 'No' ? 'selected' : ''}>No</option>
                            <option value="Yes" ${data.drugsIllicitDrugUse === 'Yes' ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Sexuality -->
            <h6 class="text-secondary mt-4 mb-3">Sexuality</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Dating Relationships</label>
                        <select class="form-select" name="datingRelationships">
                            <option value="">Select Status</option>
                            <option value="Single" ${data.datingRelationships === 'Single' ? 'selected' : ''}>Single</option>
                            <option value="Dating" ${data.datingRelationships === 'Dating' ? 'selected' : ''}>Dating</option>
                            <option value="In Relationship" ${data.datingRelationships === 'In Relationship' ? 'selected' : ''}>In Relationship</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="sexualActivity" id="sexualActivity" ${data.sexualActivity ? 'checked' : ''}>
                        <label class="form-check-label" for="sexualActivity">Sexual Activity</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Sexual Orientation</label>
                <select class="form-select" name="sexualOrientation">
                    <option value="">Select Orientation</option>
                    <option value="Heterosexual" ${data.sexualOrientation === 'Heterosexual' ? 'selected' : ''}>Heterosexual</option>
                    <option value="Homosexual" ${data.sexualOrientation === 'Homosexual' ? 'selected' : ''}>Homosexual</option>
                    <option value="Bisexual" ${data.sexualOrientation === 'Bisexual' ? 'selected' : ''}>Bisexual</option>
                    <option value="Other" ${data.sexualOrientation === 'Other' ? 'selected' : ''}>Other</option>
                    <option value="Unsure" ${data.sexualOrientation === 'Unsure' ? 'selected' : ''}>Unsure</option>
                </select>
            </div>
            
            <!-- Safety & Mental Health -->
            <h6 class="text-secondary mt-4 mb-3">Safety & Mental Health</h6>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="suicidalThoughts" id="suicidalThoughts" ${data.suicidalThoughts ? 'checked' : ''}>
                        <label class="form-check-label" for="suicidalThoughts">Suicidal Thoughts</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="selfHarmBehavior" id="selfHarmBehavior" ${data.selfHarmBehavior ? 'checked' : ''}>
                        <label class="form-check-label" for="selfHarmBehavior">Self-Harm Behavior</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="moodChanges" id="moodChanges" ${data.moodChanges ? 'checked' : ''}>
                        <label class="form-check-label" for="moodChanges">Mood Changes</label>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="feelsSafeAtHome" id="feelsSafeAtHome" ${data.feelsSafeAtHome ? 'checked' : ''}>
                        <label class="form-check-label" for="feelsSafeAtHome">Feels Safe at Home</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="feelsSafeAtSchool" id="feelsSafeAtSchool" ${data.feelsSafeAtSchool ? 'checked' : ''}>
                        <label class="form-check-label" for="feelsSafeAtSchool">Feels Safe at School</label>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="experiencedBullying" id="experiencedBullying" ${data.experiencedBullying ? 'checked' : ''}>
                        <label class="form-check-label" for="experiencedBullying">Experienced Bullying</label>
                    </div>
                </div>
            </div>
            
            <!-- Assessment Information -->
            <h6 class="text-secondary mt-4 mb-3">Assessment Information</h6>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Personal Strengths</label>
                        <input type="text" class="form-control" name="personalStrengths" value="${data.personalStrengths || ''}" placeholder="Personal strengths">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Support Systems</label>
                        <input type="text" class="form-control" name="supportSystems" value="${data.supportSystems || ''}" placeholder="Support systems">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Coping Mechanisms</label>
                        <input type="text" class="form-control" name="copingMechanisms" value="${data.copingMechanisms || ''}" placeholder="Coping mechanisms">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Assessed By</label>
                        <input type="text" class="form-control" name="assessedBy" value="${data.assessedBy || ''}" placeholder="Assessed by">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Assessment Notes</label>
                <textarea class="form-control" name="assessmentNotes" rows="3" placeholder="Assessment notes">${data.assessmentNotes || ''}</textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Recommended Actions</label>
                <textarea class="form-control" name="recommendedActions" rows="2" placeholder="Recommended actions">${data.recommendedActions || ''}</textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Follow-up Plan</label>
                <textarea class="form-control" name="followUpPlan" rows="2" placeholder="Follow-up plan">${data.followUpPlan || ''}</textarea>
            </div>
        </form>
    `;
}


function saveFormData(fileName, pageNumber) {
    const formId = pageNumber === '1' ? 'page1Form' : 'page2Form';
    const form = document.getElementById(formId);
    
    if (!form) {
        showStatus('<i class="fas fa-exclamation-circle me-2"></i>Form not found.', 'danger');
        return;
    }
    
    // Collect form data
    const formData = new FormData(form);
    formData.append('fileName', fileName);
    formData.append('pageNumber', pageNumber);
    
    // Show loading state
    const saveBtn = document.getElementById('saveFormData');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    
    // Send to server
    fetch('/Admin/HEEADSSSFormManagement?handler=SaveFormData', {
        method: 'POST',
        body: formData,
        headers: {
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.isUpdate) {
                showStatus(`<i class="fas fa-sync-alt me-2"></i>${data.message}`, 'info');
            } else {
                showStatus(`<i class="fas fa-check-circle me-2"></i>${data.message}`, 'success');
            }
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editFormModal'));
            modal.hide();
        } else {
            showStatus(`<i class="fas fa-exclamation-circle me-2"></i>${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showStatus('<i class="fas fa-exclamation-circle me-2"></i>Error saving form data.', 'danger');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}

function setActiveImage(fileName, page) {
    fetch('/Admin/HEEADSSSFormManagement?handler=SetActiveImage', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        body: `fileName=${encodeURIComponent(fileName)}&page=${encodeURIComponent(page)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`<i class="fas fa-star me-2"></i>${data.message}`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showStatus(`<i class="fas fa-exclamation-circle me-2"></i>${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showStatus('<i class="fas fa-exclamation-circle me-2"></i>Error setting active image.', 'danger');
    });
}

function deleteImage(fileName) {
    if (confirm('Are you sure you want to delete this image?')) {
        fetch('/Admin/HEEADSSSFormManagement?handler=DeleteImage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: `fileName=${encodeURIComponent(fileName)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus(`<i class="fas fa-trash me-2"></i>${data.message}`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showStatus(`<i class="fas fa-exclamation-circle me-2"></i>${data.message}`, 'danger');
            }
        })
        .catch(error => {
            showStatus('<i class="fas fa-exclamation-circle me-2"></i>Error deleting image.', 'danger');
        });
    }
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('uploadStatus');
    const alertClass = type === 'success' ? 'alert-success' : type === 'danger' ? 'alert-danger' : 'alert-info';
    
    statusDiv.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        const alert = statusDiv.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 5000);
}

// Add event listener for save button
document.addEventListener('DOMContentLoaded', function() {
    console.log('HEEADSSS Form Management page loaded');
    // Handle upload form submission
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            console.log('Upload form submitted');
            const fileInput = document.getElementById('imageFile');
            const pageSelect = document.getElementById('pageNumber');
            const submitBtn = uploadForm.querySelector('button[type="submit"]');
            
            console.log('File selected:', fileInput.files.length > 0);
            console.log('Page selected:', pageSelect.value);
            
            // Validate form
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Please select a file to upload.');
                return false;
            }
            
            if (!pageSelect.value) {
                e.preventDefault();
                alert('Please select a page number.');
                return false;
            }
            
            console.log('Form validation passed, submitting...');
            
            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
            
            // Reset button after 10 seconds (in case of error)
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }, 10000);
        });
    }
    
    // Handle upload button click
    const uploadBtn = uploadForm.querySelector('button[type="submit"]');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function(e) {
            console.log('Upload button clicked');
        });
    }
    
    // Handle save button for edit modal
    const saveBtn = document.getElementById('saveFormData');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            saveFormData(currentFileName, currentPageNumber);
        });
    }
});
</script>

