@page
@model Barangay.Pages.Account.ForgotPasswordModel
@{
    ViewData["Title"] = "Forgot Password";
}

<div class="container py-4">
    <div class="login-form-container">
        <h2 class="text-center welcome-header">
            <i class="fas fa-key"></i> Forgot Password <i class="fas fa-arrow-right arrow-icon"></i>
        </h2>
        
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                @TempData["SuccessMessage"]
            </div>
        }
        
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                @TempData["ErrorMessage"]
            </div>
        }
        
        <form method="post" id="forgotPasswordForm" class="login-form">
            <div asp-validation-summary="ModelOnly" class="text-danger validation-summary"></div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Enter your email address and we'll send you a verification code to reset your password.
            </div>
            
            <div class="form-group">
                <label asp-for="Input.Email" class="form-label">Email Address <span class="required">*</span></label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-envelope"></i>
                    </span>
                    <input asp-for="Input.Email" class="form-control" placeholder="Enter your email address" aria-label="Email input" required aria-required="true" />
                </div>
                <div class="invalid-feedback" id="emailError">Email address is required</div>
                <span asp-validation-for="Input.Email" class="text-danger error-message"></span>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-primary w-100 login-button" id="nextButton" onclick="showPasswordFields()">
                    <span class="login-button-content">
                        <i class="fas fa-arrow-right me-2"></i> Next
                    </span>
                </button>
            </div>
            
            <!-- Password Fields (Initially Hidden) -->
            <div id="passwordFields" class="d-none">
                <div class="form-group">
                    <label class="form-label">New Password <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" class="form-control" id="newPassword" placeholder="Enter your new password" required />
                        <button class="btn btn-outline-secondary toggle-password" type="button" id="toggleNewPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm New Password <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm your new password" required />
                        <button class="btn btn-outline-secondary toggle-password" type="button" id="toggleConfirmPassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Verification Code <span class="required">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-key"></i>
                        </span>
                        <input type="text" class="form-control text-center" id="otpCode" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required />
                    </div>
                    <small class="form-text text-muted">
                        We'll send a 6-digit verification code to your email.
                    </small>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success w-100 login-button" id="resetPasswordButton">
                        <span class="login-button-content">
                            <i class="fas fa-save me-2"></i> Reset Password
                        </span>
                        <span class="login-button-spinner d-none">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Resetting...
                        </span>
                    </button>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <div>
                    <span class="text-dark">Remember your password?</span> 
                    <a asp-page="./Login" class="register-link">
                        <strong>Back to Login</strong>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function showPasswordFields() {
            const email = document.getElementById('Input_Email').value;
            if (!email) {
                alert('Please enter your email address first.');
                return;
            }
            
            // Hide the Next button and show password fields
            document.getElementById('nextButton').classList.add('d-none');
            document.getElementById('passwordFields').classList.remove('d-none');
            
            // Send OTP automatically
            sendOTP(email);
        }
        
        function sendOTP(email) {
            fetch('?handler=SendOTP', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Verification code sent to ' + email + '! Please check your email.');
                } else {
                    alert('❌ Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('❌ Error sending verification code. Please try again.');
                console.error('Error:', error);
            });
        }
        
        // Password visibility toggle
        document.getElementById('toggleNewPassword').addEventListener('click', function() {
            const passwordField = document.getElementById('newPassword');
            const icon = this.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
            const passwordField = document.getElementById('confirmPassword');
            const icon = this.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });
        
        // OTP input formatting
        document.getElementById('otpCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 6) {
                this.value = this.value.substring(0, 6);
            }
        });
        
        // Form submission
        document.getElementById('forgotPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('Input_Email').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const otpCode = document.getElementById('otpCode').value;
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('❌ Passwords do not match!');
                return;
            }
            
            // Validate OTP
            if (otpCode.length !== 6) {
                alert('❌ Please enter the complete 6-digit verification code.');
                return;
            }
            
            const button = document.getElementById('resetPasswordButton');
            const content = button.querySelector('.login-button-content');
            const spinner = button.querySelector('.login-button-spinner');
            
            // Show loading state
            button.disabled = true;
            content.classList.add('d-none');
            spinner.classList.remove('d-none');
            
            // Submit the form
            fetch('?handler=ResetPassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `email=${encodeURIComponent(email)}&newPassword=${encodeURIComponent(newPassword)}&otpCode=${encodeURIComponent(otpCode)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ Password reset successfully! You can now log in with your new password.');
                    window.location.href = '/Account/Login';
                } else {
                    alert('❌ Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('❌ Error resetting password. Please try again.');
                console.error('Error:', error);
            })
            .finally(() => {
                button.disabled = false;
                content.classList.remove('d-none');
                spinner.classList.add('d-none');
            });
        });
    </script>
}
