@page "{handler?}"
@model Barangay.Pages.Account.SignUpModel
@{
    ViewData["Title"] = "Sign Up";
}

<div class="container py-4">
    <div class="signup-container">
        <h2 class="text-center">
            <i class="fas fa-user-plus"></i> Create Your Account
        </h2>
        
        <!-- Wizard Progress -->
        <div class="wizard-progress mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div id="step1Indicator" class="step-indicator active">1. Personal</div>
                <div id="step2Indicator" class="step-indicator">2. Security</div>
                <div id="step3Indicator" class="step-indicator">3. Verification</div>
            </div>
            <div class="progress mt-2" style="height: 6px;">
                <div id="registrationProgress" class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small id="progressText" class="text-muted">Step 1: Personal Information</small>
        </div>
        
        <form method="post" enctype="multipart/form-data" id="signupForm">

            
            <!-- Personal Information Section -->
            <div id="section1" class="section">
                <h4 class="text-primary"><i class="fas fa-user"></i> Personal Information</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Username" class="form-label">Username <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-user"></i>
                                </span>
                                <input asp-for="Input.Username" class="form-control" placeholder="Username (min. 3 characters)" aria-label="Username input" required />
                            </div>
                            <div class="invalid-feedback" id="usernameError">Username is required</div>
                            <span asp-validation-for="Input.Username" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Email" class="form-label">Email Address <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input asp-for="Input.Email" class="form-control" placeholder="Email address" type="email" aria-label="Email input" required />
                            </div>
                            <div class="invalid-feedback" id="emailError">Email address is required</div>
                            <span asp-validation-for="Input.Email" class="text-danger"></span>
                        </div>
                        <!-- Simplified Email Verification Status -->
                        <div id="emailVerificationStatus" class="mt-3 d-none">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-check-circle text-success"></i>
                                <span class="text-success fw-bold">Email Verified</span>
                            </div>
                        </div>
                        
                        <!-- OTP Input Field -->
                        <div id="otpInputSection" class="mt-3 d-none">
                            <div class="mb-2">
                                <label class="form-label small">Enter 6-digit verification code:</label>
                                <input type="text" id="otpInput" class="form-control form-control-sm" placeholder="000000" maxlength="6" style="width: 120px;" />
                            </div>
                        </div>
                        
                        <!-- Email Verification Actions -->
                        <div id="emailVerificationActions" class="mt-3">
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="verifyEmailBtn">Verify Email</button>
                                <button type="button" class="btn btn-link btn-sm" id="resendEmailBtn">Resend</button>
                                <small id="resendCountdown" class="text-muted" aria-live="polite"></small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Input.FirstName" class="form-label">First Name <span class="required">*</span></label>
                            <input asp-for="Input.FirstName" class="form-control" placeholder="First name" aria-label="First name input" required />
                            <div class="invalid-feedback" id="firstNameError">First name is required</div>
                            <span asp-validation-for="Input.FirstName" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Input.MiddleName" class="form-label">Middle Name <span class="text-muted">(Optional)</span></label>
                            <input asp-for="Input.MiddleName" class="form-control" placeholder="Middle name (optional)" aria-label="Middle name input (optional)" />
                            <span asp-validation-for="Input.MiddleName" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Input.LastName" class="form-label">Last Name <span class="required">*</span></label>
                            <input asp-for="Input.LastName" class="form-control" placeholder="Last name" required aria-label="Last name input" />
                            <div class="invalid-feedback" id="lastNameError">Last name is required</div>
                            <span asp-validation-for="Input.LastName" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Suffix" class="form-label">Suffix <span class="text-muted">(Optional)</span></label>
                            <input asp-for="Input.Suffix" class="form-control" placeholder="Suffix (optional)" aria-label="Suffix input (optional)" />
                            <span asp-validation-for="Input.Suffix" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.ContactNumber" class="form-label">Contact Number <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-phone"></i>
                                </span>
                                <input asp-for="Input.ContactNumber" class="form-control" placeholder="e.g., 09171234567" required aria-label="Contact number input" />
                            </div>
                            <div class="invalid-feedback" id="contactNumberError">Contact number is required</div>
                            <small class="form-text text-muted">Valid formats: 09XXXXXXXXX or +639XXXXXXXXX</small>
                            <span asp-validation-for="Input.ContactNumber" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label asp-for="Input.Address" class="form-label">Complete Address <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-map-marker-alt"></i>
                                </span>
                                <textarea asp-for="Input.Address" class="form-control" rows="2" placeholder="House No., Street, Barangay, City" required aria-label="Complete address input"></textarea>
                            </div>
                            <div class="invalid-feedback" id="addressError">Complete address is required</div>
                            <small class="form-text text-muted">Please provide your complete address including house number, street, barangay, and city</small>
                            <span asp-validation-for="Input.Address" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Age" class="form-label">Age <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <input asp-for="Input.Age" class="form-control" placeholder="e.g., 25" required aria-label="Age input" maxlength="3" />
                            </div>
                            <div class="invalid-feedback" id="ageError">Age is required</div>
                            <small class="form-text text-muted">Enter your age in years</small>
                            <span asp-validation-for="Input.Age" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.BirthDate" class="form-label">Birth Date <span class="required">*</span></label>
                            <input asp-for="Input.BirthDate" class="form-control" type="date" required aria-label="Birth date input" id="Input_BirthDate" />
                            <div class="invalid-feedback" id="birthDateError">Birth date is required</div>
                            <small class="form-text text-muted">For users under 18, parent/guardian consent is required</small>
                            <span asp-validation-for="Input.BirthDate" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Barangay" class="form-label">Barangay <span class="required">*</span></label>
                            <select asp-for="Input.Barangay" class="form-select" required aria-label="Barangay selection">
                                <option value="">Select barangay</option>
                                <option value="158">158</option>
                                <option value="159">159</option>
                                <option value="160">160</option>
                                <option value="161">161</option>
                            </select>
                            <span asp-validation-for="Input.Barangay" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Gender Field -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Gender" class="form-label">Gender <span class="required">*</span></label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" asp-for="Input.Gender" id="genderMale" value="Male" required>
                                    <label class="form-check-label" for="genderMale">Male</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" asp-for="Input.Gender" id="genderFemale" value="Female" required>
                                    <label class="form-check-label" for="genderFemale">Female</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" asp-for="Input.Gender" id="genderOther" value="Other" required>
                                    <label class="form-check-label" for="genderOther">Other</label>
                                </div>
                            </div>
                            <span asp-validation-for="Input.Gender" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Guardian Information Section -->
                <div id="guardianInfoSection" class="form-group mb-4 border p-3 rounded bg-light" style="display: none;">
                    <h5 class="mb-3"><i class="fas fa-shield-alt me-2"></i>Guardian Information</h5>
                    
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <span>Since you are under 18 years old, we need your parent or guardian's consent to proceed with registration.</span>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label asp-for="Input.GuardianFirstName" class="form-label">Guardian's First Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input asp-for="Input.GuardianFirstName" class="form-control" id="guardianFirstName" data-required="true" placeholder="Enter guardian's first name" />
                        </div>
                        <span asp-validation-for="Input.GuardianFirstName" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label asp-for="Input.GuardianLastName" class="form-label">Guardian's Last Name <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-user"></i></span>
                            <input asp-for="Input.GuardianLastName" class="form-control" id="guardianLastName" data-required="true" placeholder="Enter guardian's last name" />
                        </div>
                        <span asp-validation-for="Input.GuardianLastName" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="Input.GuardianResidencyProof" class="form-label">Guardian's Residency Proof <span class="text-danger">*</span></label>
                        <input asp-for="Input.GuardianResidencyProof" class="form-control" type="file" id="guardianResidencyProof" accept=".jpg,.jpeg,.png,.pdf" data-required="true" />
                        <span asp-validation-for="Input.GuardianResidencyProof" class="text-danger"></span>
                        <small class="form-text text-muted">Accepted formats: JPG, JPEG, PNG, PDF (Max size: 5MB)</small>
                    </div>
                </div>

                

                <!-- Navigation: Step 1 -->
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" id="nextToSecurity" class="btn btn-primary">
                        Next
                    </button>
                </div>
            </div>
            
            <!-- Account Security Section -->
            <div id="section2" class="section d-none">
                <h4 class="text-primary"><i class="fas fa-shield-alt"></i> Account Security</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.Password" class="form-label">Password <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="Input.Password" class="form-control" type="password" id="password" aria-label="Password input" aria-describedby="passwordRequirements" required />
                                <button class="btn btn-outline-secondary toggle-password" type="button" id="togglePassword" tabindex="0" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="passwordError">Password is required</div>
                            
                            <!-- Password Strength Meter -->
                            <div class="password-strength-meter mt-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-dark">Password Strength:</small>
                                    <small class="password-strength-text">Too weak</small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="passwordStrength"></div>
                                </div>
                            </div>
                            
                            <!-- Password Feedback -->
                            <div id="passwordFeedback" class="password-feedback mt-2 p-2 border rounded bg-light d-none">
                                <!-- Feedback will be inserted here by JavaScript -->
                            </div>
                            
                            <!-- Password Requirements -->
                            <div class="password-requirements mt-2 p-2 border rounded bg-light" id="passwordRequirements">
                                <p class="mb-1 text-dark"><strong>Password Requirements:</strong></p>
                                <ul class="ps-3 mb-0 text-dark" id="requirementsList">
                                    <li id="length"><i class="fas fa-times text-danger me-1"></i> At least 8 characters</li>
                                    <li id="uppercase"><i class="fas fa-times text-danger me-1"></i> At least 1 uppercase letter</li>
                                    <li id="lowercase"><i class="fas fa-times text-danger me-1"></i> At least 1 lowercase letter</li>
                                    <li id="number"><i class="fas fa-times text-danger me-1"></i> At least 1 number</li>
                                    <li id="special"><i class="fas fa-times text-danger me-1"></i> At least 1 special character</li>
                                </ul>
                            </div>
                            
                            <!-- Breached Password Warning (will be shown via JS) -->
                            <div class="alert alert-warning mt-2 d-none" id="breachedPasswordWarning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span>This password appears in known data breaches. Please choose a different password.</span>
                            </div>
                            
                            <span asp-validation-for="Input.Password" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="Input.ConfirmPassword" class="form-label">Confirm Password <span class="required">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input asp-for="Input.ConfirmPassword" class="form-control" type="password" id="confirmPassword" aria-label="Confirm password input" required />
                                <button class="btn btn-outline-secondary toggle-password" type="button" id="toggleConfirmPassword" tabindex="0" aria-label="Toggle confirm password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="confirmPasswordError">Confirm password is required</div>
                            
                            <!-- Password Match Indicator -->
                            <div class="password-match-indicator mt-2">
                                <div class="alert alert-success py-2 d-none" id="passwordMatch">
                                    <i class="fas fa-check-circle me-2"></i> Passwords match
                                </div>
                                <div class="alert alert-danger py-2 d-none" id="passwordMismatch">
                                    <i class="fas fa-times-circle me-2"></i> Passwords do not match
                                </div>
                            </div>
                            
                            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <!-- Navigation: Step 2 -->
                <div class="d-flex justify-content-between mt-3">
                    <button type="button" id="backToPersonal" class="btn btn-outline-secondary">Back</button>
                    <button type="button" id="nextToVerification" class="btn btn-primary">Next</button>
                </div>
            </div>
            
            <!-- Residency Verification Section -->
            <div id="section3" class="section d-none">
                <h4 class="text-primary"><i class="far fa-address-card"></i> Residency Verification</h4>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <span class="text-dark">Please upload your Barangay Clearance or valid ID to verify your residency in Barangay 158, 159, 160,161.</span>
                </div>
                
                <div class="form-group">
                    <label asp-for="Input.ResidencyProof" class="form-label">Residency Proof <span class="required">*</span></label>
                    <input asp-for="Input.ResidencyProof" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg" id="residencyProofFile" required aria-label="Residency proof file input" />
                    <div class="invalid-feedback" id="fileError">Please upload your residency proof document</div>
                    <div id="fileNameDisplay" class="file-info mt-2 d-none"></div>
                    <div class="mt-2">
                        <small class="form-text text-dark">
                            <ul class="ps-3 mb-0">
                                <li>Accepted file types: PDF, PNG, JPG, JPEG</li>
                                <li>Maximum file size: 5MB</li>
                                <li>Documents must clearly show your name and address</li>
                            </ul>
                        </small>
                    </div>
                    <span asp-validation-for="Input.ResidencyProof" class="text-danger"></span>
                </div>
                
                <p class="mb-2 text-dark">Your document will be reviewed by an administrator for verification.</p>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" name="Input.AgreeToTerms" id="privacyTerms" class="form-check-input" aria-label="Agree to terms checkbox" required value="true" />
                        <label class="form-check-label text-dark" for="privacyTerms">
                            I have read and agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Data Privacy Terms</a> (Republic Act 10173)
                        </label>
                        <div class="invalid-feedback" id="privacyTermsError">
                            You must agree to the Data Privacy Terms to continue
                        </div>
                        <span asp-validation-for="Input.AgreeToTerms" class="text-danger"></span>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" name="Input.ConfirmResidency" id="residencyConfirm" class="form-check-input" aria-label="Confirm residency checkbox" required value="true" />
                        <label class="form-check-label text-dark" for="residencyConfirm">
                            I confirm that I am a resident of Barangay 158, 159, 160, 161 and all information provided is correct
                        </label>
                        <div class="invalid-feedback" id="residencyConfirmError">
                            You must confirm your residency to continue
                        </div>
                        <span asp-validation-for="Input.ConfirmResidency" class="text-danger"></span>
                    </div>
                </div>
                
                <!-- Hidden fields to ensure the values are submitted even when checkboxes are not checked -->
                <input type="hidden" name="Input.AgreeToTerms" value="false" />
                <input type="hidden" name="Input.ConfirmResidency" value="false" />
                
                <div id="checkboxErrorContainer" class="alert alert-danger mt-3 d-none">
                    <strong>Error:</strong> <span id="checkboxErrorMessage">You must agree to the terms and conditions and confirm your residency</span>
                </div>
                <!-- Navigation + Submit: Step 3 -->
                <div class="d-flex justify-content-between mt-3">
                    <button type="button" id="backToSecurity" class="btn btn-outline-secondary">Back</button>
                    <button type="submit" class="btn btn-primary" id="signupButton">
                        <i class="fas fa-user-plus me-2"></i> Register Account
                    </button>
                </div>

                <div id="loadingIndicator" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your registration, please wait...</p>
                </div>

                <noscript>
                    <button type="submit" class="btn btn-primary btn-block mt-2 w-100" id="fallbackSubmit">
                        Register Account (No JavaScript)
                    </button>
                </noscript>
            </div>
            
            <script>
                // Show loading indicator on form submit
                document.addEventListener('DOMContentLoaded', function() {
                    const form = document.getElementById('signupForm');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    const submitButton = document.getElementById('signupButton');
                    
                    if (form && loadingIndicator && submitButton) {
                        form.addEventListener('submit', function() {
                            console.log('Form submitted, showing loading indicator');
                            loadingIndicator.classList.remove('d-none');
                            submitButton.disabled = true;
                            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                        });
                    }
                });
            </script>
            
            <div class="text-center mt-3">
                <span class="text-dark">Already have an account?</span> <a asp-area="" asp-controller="Home" asp-action="Index" class="login-link">Log In</a>
            </div>
            

        </form>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Data Privacy Terms</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>Republic Act 10173 - Data Privacy Act of 2012</h6>
                <p class="text-dark">The Barangay Health Center is committed to protecting your personal information in accordance with the Data Privacy Act of 2012 (Republic Act 10173).</p>
                
                <h6>Information We Collect</h6>
                <p class="text-dark">We collect personal information such as your name, contact information, residency details, and health information for the purpose of providing you with health services.</p>
                
                <h6>How We Use Your Information</h6>
                <p class="text-dark">Your information will be used for:</p>
                <ul>
                    <li class="text-dark">Processing your health service requests</li>
                    <li class="text-dark">Creating and maintaining your patient record</li>
                    <li class="text-dark">Communicating with you about appointments and health services</li>
                    <li class="text-dark">Verifying your identity and residency</li>
                </ul>
                
                <h6>Protection of Your Information</h6>
                <p class="text-dark">We implement appropriate security measures to protect your personal information against unauthorized access or disclosure.</p>
                
                <h6>Your Rights</h6>
                <p class="text-dark">You have the right to:</p>
                <ul>
                    <li class="text-dark">Be informed about how your data is processed</li>
                    <li class="text-dark">Access your personal information</li>
                    <li class="text-dark">Correct inaccuracies in your data</li>
                    <li class="text-dark">Object to processing in certain circumstances</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="acceptTerms" data-bs-dismiss="modal">Accept Terms</button>
            </div>
        </div>
    </div>
</div>

<!-- Post-Registration Success Modal -->
<div class="modal fade" id="registrationSuccessModal" tabindex="-1" aria-labelledby="registrationSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content registration-success-modal">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div class="success-icon-container mb-4">
                    <i class="fas fa-check-circle text-success success-icon"></i>
                </div>
                <h4 class="fw-bold text-dark mb-3">Registration Successful!</h4>
                <p class="text-muted mb-4">Your account is pending admin approval. You will receive an email notification once your account has been verified.</p>
                <p class="small text-muted">Please make sure to check your email inbox and spam folder.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-primary px-4 py-2" data-bs-dismiss="modal" id="successCloseBtn">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- zxcvbn password strength library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js" integrity="sha512-TZlMGFY9xKj38t/5m2FzJ+RM/aD5alMHDe26p0mYUMoCF5G7ibfHUQILq0qQPV3wlsnCwL+TPRNK4vIWGLOkUQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="~/js/signup.js" asp-append-version="true"></script>
    <script src="~/js/password-validation.js" asp-append-version="true"></script>
    <script src="~/js/form-validation.js" asp-append-version="true"></script>
    <script>
        // Debug Console Logging
        console.log('SignUp page scripts loaded');
        
        // Check if Bootstrap is available
        console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
        
        // Add error event handler to catch any unhandled JavaScript errors
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Log key elements to verify they're found in the DOM
            console.log('DOM fully loaded');
            console.log('Birth date input:', document.getElementById('Input_BirthDate'));
            console.log('Guardian consent modal:', document.getElementById('guardianConsentModal'));
            console.log('Parent name input:', document.getElementById('parentName'));
            console.log('Form found:', document.querySelector('form#signupForm'));
            
            // Check if form submission is working
            const form = document.querySelector('form#signupForm');
            if (form) {
                const originalSubmit = form.submit;
                form.submit = function() {
                    console.log('Form submit() called programmatically');
                    return originalSubmit.apply(this, arguments);
                };
            }
            });

            // Client-side validation for Dummy Contact Number
            $.validator.addMethod("notadummynumber", function (value, element) {
                if (!value) return true; 
                const digits = value.replace(/\D/g, '');
                if (digits.length > 9) {
                    const last9 = digits.substring(digits.length - 9);
                    if (/^(\d)\1+$/.test(last9)) {
                        return false; // Invalid if all same digits
                    }
                }
                return true;
            });
            $.validator.unobtrusive.adapters.addBool("notadummynumber");

            // Client-side validation for Gibberish Name
            $.validator.addMethod("notgibberishname", function (value, element) {
                if (!value) return true;
                // Check for 5+ repeated characters
                if (/(.)\1{4}/.test(value)) {
                    return false;
                }
                // Basic check for keyboard mashing
                if (/(asdf|jkl;)/i.test(value)) {
                    return false;
                }
                return true;
            });
            $.validator.unobtrusive.adapters.addBool("notgibberishname");

            // Guardian Information Section Handler
            const birthDateInput = document.getElementById('Input_BirthDate');
            const guardianInfoSection = document.getElementById('guardianInfoSection');

            function calculateAge(birthDateString) {
                if (!birthDateString) return null;
                const birthDate = new Date(birthDateString);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDifference = today.getMonth() - birthDate.getMonth();
                if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            function toggleGuardianSection() {
                 const age = calculateAge(birthDateInput.value);
                 if (age !== null && age < 18) {
                     guardianInfoSection.style.display = 'block';
                 } else {
                     guardianInfoSection.style.display = 'none';
                 }
            }

            if (birthDateInput) {
                birthDateInput.addEventListener('change', toggleGuardianSection);
                // Initial check in case the page loads with a date
                toggleGuardianSection();
            }

                // Simplified Email Verification with OTP Input
                (function initEmailVerification() {
                    const emailInput = document.getElementById('Input_Email');
                    const verificationStatus = document.getElementById('emailVerificationStatus');
                    const verificationActions = document.getElementById('emailVerificationActions');
                    const otpInputSection = document.getElementById('otpInputSection');
                    const otpInput = document.getElementById('otpInput');
                    const verifyBtn = document.getElementById('verifyEmailBtn');
                    const resendBtn = document.getElementById('resendEmailBtn');
                    const countdownEl = document.getElementById('resendCountdown');

                    let countdownTimer = null;
                    let isVerified = false;

                    // 30s resend countdown
                    function startResendCountdown(seconds = 30) {
                        if (!resendBtn || !countdownEl) return;
                        let remaining = seconds;
                        resendBtn.disabled = true;
                        countdownEl.textContent = `Resend in ${remaining}s`;
                        clearInterval(countdownTimer);
                        countdownTimer = setInterval(() => {
                            remaining--;
                            if (remaining <= 0) {
                                clearInterval(countdownTimer);
                                resendBtn.disabled = false;
                                countdownEl.textContent = 'Resend now';
                            } else {
                                countdownEl.textContent = `Resend in ${remaining}s`;
                            }
                        }, 1000);
                    }

                    // Send verification email
                    function sendVerificationEmail() {
                        if (!emailInput || !emailInput.value) {
                            alert('Please enter a valid email address');
                            return;
                        }
                        
                        fetch('/api/OTP/send', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email: emailInput.value })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                startResendCountdown(30);
                                // Show OTP input field
                                otpInputSection.classList.remove('d-none');
                                otpInput.focus();
                                alert('Verification code sent! Please enter the 6-digit code below.');
                            } else {
                                alert(data.message || 'Failed to send verification email');
                            }
                        })
                        .catch(error => {
                            console.error('Error sending verification email:', error);
                            alert('Failed to send verification email. Please try again.');
                        });
                    }

                    // Verify email with OTP
                    function verifyEmail() {
                        if (!emailInput || !emailInput.value) {
                            alert('Please enter a valid email address');
                            return;
                        }

                        const otp = otpInput.value.trim();
                        if (!otp || otp.length !== 6) {
                            alert('Please enter a valid 6-digit verification code');
                            otpInput.focus();
                            return;
                        }

                        fetch('/api/OTP/verify', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                email: emailInput.value,
                                otp: otp
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                isVerified = true;
                                
                                // Show verification status
                                verificationStatus.classList.remove('d-none');
                                verificationActions.classList.add('d-none');
                                otpInputSection.classList.add('d-none');
                                
                                // Mark email input as verified
                                emailInput.classList.add('is-valid');
                                emailInput.readOnly = true;
                                
                                // Add hidden field to indicate email is verified
                                const form = emailInput.closest('form');
                                if (form) {
                                    const hiddenField = document.createElement('input');
                                    hiddenField.type = 'hidden';
                                    hiddenField.name = 'EmailVerified';
                                    hiddenField.value = 'true';
                                    form.appendChild(hiddenField);
                                }
                                
                                alert('Email verified successfully!');
                            } else {
                                alert(data.message || 'Invalid verification code');
                                otpInput.value = '';
                                otpInput.focus();
                            }
                        })
                        .catch(error => {
                            console.error('Error verifying OTP:', error);
                            alert('Failed to verify code. Please try again.');
                        });
                    }

                    // Event listeners
                    if (verifyBtn) {
                        verifyBtn.addEventListener('click', verifyEmail);
                    }

                    if (resendBtn) {
                        resendBtn.addEventListener('click', () => {
                            if (resendBtn.disabled) return;
                            sendVerificationEmail();
                        });
                    }

                    // Allow Enter key to verify OTP
                    if (otpInput) {
                        otpInput.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                verifyEmail();
                            }
                        });
                    }

                    // Auto-send verification email when email field loses focus
                    if (emailInput) {
                        emailInput.addEventListener('blur', () => {
                            if (emailInput.value && !isVerified && !resendBtn.disabled) {
                                sendVerificationEmail();
                            }
                        });
                    }

                    // Send verification email when page loads if email is already filled
                    if (emailInput && emailInput.value && !isVerified) {
                        sendVerificationEmail();
                    }
                })();
    </script>
}
