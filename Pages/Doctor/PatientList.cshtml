@page
@model Barangay.Pages.Doctor.PatientListModel
@{
    ViewData["Title"] = "Patient List";
    Layout = "_DoctorLayout";
}

<style>
    .filter-card {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
    }

    .patient-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1rem;
    }

    .patient-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }

    .search-box {
        position: relative;
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }

    .search-box input {
        padding-left: 2.5rem;
    }

    @@media (max-width: 768px) {
        .filter-buttons {
            flex-direction: column;
        }

        .filter-buttons .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
    
    /* Medical Certificate Styles */
    .certificate-container {
        background: white;
        padding: 25px;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .certificate-header {
        border-bottom: 3px solid #fd7e14;
        padding-bottom: 20px;
        margin-bottom: 25px;
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        border-radius: 8px 8px 0 0;
        padding: 20px;
        margin: -25px -25px 25px -25px;
    }
    .certificate-header h4 {
        color: #fd7e14;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .certificate-header h3 {
        color: #333;
        font-weight: bold;
        margin-top: 15px;
    }
    .certificate-body {
        line-height: 1.8;
    }
    .certificate-body .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    .certificate-body .form-control {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 12px;
        transition: all 0.3s ease;
    }
    .certificate-body .form-control:focus {
        border-color: #fd7e14;
        box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
        background-color: #fff;
    }
    .certificate-body .form-control[readonly] {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    .certificate-body small {
        font-size: 0.875em;
        color: #6c757d;
    }
    .certificate-body .alert {
        border-radius: 8px;
        border: none;
    }
    .certificate-body .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .certificate-body .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    .certificate-body hr {
        border-color: #fd7e14;
        opacity: 0.3;
    }
</style>

<!-- Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
    <h1 class="h2">Patient List</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
            <i class="fas fa-sync-alt me-1"></i> Refresh
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card filter-card">
    <div class="card-body">
        <form method="get" id="filterForm">
            <div class="row g-3">
                <!-- Search -->
                <div class="col-md-4">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="searchQuery" name="searchQuery" 
                               value="@Model.SearchQuery" placeholder="Search by name, email, or ID...">
                    </div>
                </div>

                <!-- Barangay Filter -->
                <div class="col-md-3">
                    <select class="form-select" id="barangay" name="barangay" asp-for="@Model.SelectedBarangay"
                            asp-items="@Model.BarangayList">
                        <option value="">All Barangays</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div class="col-md-3">
                    <select class="form-select" id="status" name="status" asp-for="@Model.SelectedStatus">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>

                <!-- Filter Buttons -->
                <div class="col-md-2 d-flex gap-2 filter-buttons">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fas fa-filter me-1"></i> Filter
                    </button>
                    <a href="/Doctor/PatientList" class="btn btn-outline-secondary flex-fill">
                        <i class="fas fa-times me-1"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Patient List -->
<div class="row">
    @if (!Model.Patients.Any())
    {
        <div class="col-12">
            <div class="text-center text-muted py-5">
                <i class="fas fa-users fa-3x mb-3"></i>
                <h5>No patients found</h5>
                <p>Try adjusting your filters or search criteria</p>
            </div>
        </div>
    }
    else
    {
        @foreach (var patient in Model.Patients)
        {
            <div class="col-12">
                <div class="card patient-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="fas fa-user-circle fa-2x text-primary"></i>
                            </div>
                            <div class="col-md-3">
                                <h5 class="card-title mb-1">@patient.FullName</h5>
                                <p class="text-muted mb-0">
                                    <small>
                                        <i class="fas fa-id-card me-1"></i> @patient.PatientId
                                    </small>
                                </p>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-0">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    @patient.Barangay
                                </p>
                            </div>
                            <div class="col-md-2">
                                <p class="mb-0">
                                    <i class="fas fa-phone me-1"></i>
                                    @patient.PhoneNumber
                                </p>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-@(patient.Status == "Active" ? "success" : 
                                                     patient.Status == "Pending" ? "warning" : "secondary")">
                                    @patient.Status
                                </span>
                            </div>
                            <div class="col-md-2 text-end">
                                <div class="btn-group" role="group">
                                <a href="/Doctor/PatientDetails/@patient.PatientId" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye me-1"></i> View Details
                                </a>
                                    <button type="button" class="btn btn-sm btn-success" onclick="openMedicalCertificate('@patient.PatientId', '@patient.FullName', '@patient.Age')">
                                        <i class="fas fa-certificate me-1"></i> Certificate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="col-12">
                <nav aria-label="Patient list navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Model.GetPageUrl(Model.CurrentPage - 1)">Previous</a>
                        </li>
                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="@Model.GetPageUrl(i)">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="@Model.GetPageUrl(Model.CurrentPage + 1)">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    }
</div>

<!-- Medical Certificate Modal -->
<div class="modal fade" id="medicalCertificateModal" tabindex="-1" aria-labelledby="medicalCertificateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="medicalCertificateModalLabel">Medical Certificate</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="certificate-container" id="certificateContent">
                    <div class="certificate-header text-center mb-4">
                        <h4 class="mb-1">BRGY. 161 BAESA HEALTH CENTER</h4>
                        <p class="mb-1">356, ROSE CALOOCAN CITY</p>
                        <p class="mb-3">baesahealthcenter2021@gmail.com</p>
                        <h3 class="mb-4"><strong>MEDICAL CERTIFICATE</strong></h3>
                        <div class="text-end mb-3">
                            <strong>DATE: <span id="certificateDate">@DateTime.Now.ToString("MMMM dd, yyyy")</span></strong>
                        </div>
                    </div>
                    
                    <div class="certificate-body">
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Preview:</strong> This is a preview of your medical certificate. Fill in the details below and click "Print Certificate" to generate the final document.
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="patientName" class="form-label fw-bold">Patient Name:</label>
                                <input type="text" class="form-control" id="patientName" value="" readonly>
                                <small class="text-muted">Auto-filled from patient record</small>
                            </div>
                            <div class="col-md-6">
                                <label for="patientAge" class="form-label fw-bold">Age:</label>
                                <input type="text" class="form-control" id="patientAge" value="" readonly>
                                <small class="text-muted">Auto-filled from patient record</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="reason" class="form-label fw-bold">Reason for Consultation:</label>
                            <input type="text" class="form-control" id="reason" placeholder="e.g., Annual check-up, fever, headache, etc.">
                            <small class="text-muted">Brief description of why the patient came for consultation</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="impression" class="form-label fw-bold">Medical Impression:</label>
                            <textarea class="form-control" id="impression" rows="3" placeholder="Enter your medical findings and diagnosis..."></textarea>
                            <small class="text-muted">Your professional medical assessment</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="remarks" class="form-label fw-bold">Additional Remarks:</label>
                            <textarea class="form-control" id="remarks" rows="3" placeholder="Any additional notes or recommendations..."></textarea>
                            <small class="text-muted">Optional: Additional notes or recommendations</small>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label for="doctorName" class="form-label fw-bold">Doctor Name:</label>
                                <input type="text" class="form-control" id="doctorName" value="@User.Identity?.Name">
                            </div>
                            <div class="col-md-6">
                                <label for="doctorTitle" class="form-label fw-bold">Title/Position:</label>
                                <input type="text" class="form-control" id="doctorTitle" value="Medical Officer III">
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mt-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> This certificate is for general purposes only and is not valid for medico-legal purposes.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancel
                </button>
                <button type="button" class="btn btn-success" id="printCertificate">
                    <i class="fas fa-print me-1"></i> Print Certificate
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-submit form when select filters change
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', () => {
                    document.getElementById('filterForm').submit();
                });
            });

            // Debounce search input
            let searchTimeout;
            const searchInput = document.getElementById('searchQuery');
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    document.getElementById('filterForm').submit();
                }, 500);
            });
            
            // Handle print certificate button
            document.getElementById('printCertificate').addEventListener('click', function() {
                printCertificate();
            });
        });
        
        // Function to open medical certificate modal
        function openMedicalCertificate(patientId, patientName, patientAge) {
            // Set patient information
            document.getElementById('patientName').value = patientName;
            document.getElementById('patientAge').value = patientAge;
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('medicalCertificateModal'));
            modal.show();
        }
        
        // Function to print the certificate
        function printCertificate() {
            // Get the current values from the form
            const patientName = document.getElementById('patientName').value;
            const patientAge = document.getElementById('patientAge').value;
            const reason = document.getElementById('reason').value;
            const impression = document.getElementById('impression').value;
            const remarks = document.getElementById('remarks').value;
            const doctorName = document.getElementById('doctorName').value;
            const doctorTitle = document.getElementById('doctorTitle').value;
            const certificateDate = document.getElementById('certificateDate').textContent;
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            // Create the printable HTML with filled data
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Medical Certificate</title>
                    <style>
                        body {
                            font-family: 'Times New Roman', serif;
                            margin: 0;
                            padding: 0;
                            background: white;
                            color: black;
                            font-size: 12pt;
                            line-height: 1.8;
                        }
                        .certificate-container {
                            max-width: 8.5in;
                            margin: 0 auto;
                            background: white;
                            padding: 1in;
                            min-height: 11in;
                            position: relative;
                        }
                        .certificate-header {
                            text-align: center;
                            margin-bottom: 50px;
                        }
                        .certificate-header h4 {
                            font-size: 14pt;
                            margin: 5px 0;
                            font-weight: bold;
                            letter-spacing: 0.5px;
                        }
                        .certificate-header p {
                            font-size: 11pt;
                            margin: 2px 0;
                        }
                        .certificate-header h3 {
                            font-size: 18pt;
                            margin: 30px 0 20px 0;
                            font-weight: bold;
                            letter-spacing: 1px;
                        }
                        .date-section {
                            text-align: right;
                            margin-bottom: 40px;
                            font-weight: bold;
                            font-size: 12pt;
                        }
                        .certificate-body {
                            line-height: 2.2;
                            font-size: 12pt;
                            text-align: left;
                        }
                        .certificate-body p {
                            margin: 20px 0;
                        }
                        .filled-text {
                            border-bottom: 1px solid #000;
                            padding-bottom: 2px;
                            display: inline-block;
                            min-width: 200px;
                            font-weight: bold;
                        }
                        .filled-text-short {
                            border-bottom: 1px solid #000;
                            padding-bottom: 2px;
                            display: inline-block;
                            min-width: 100px;
                            font-weight: bold;
                        }
                        .filled-text-long {
                            border-bottom: 1px solid #000;
                            padding-bottom: 2px;
                            display: block;
                            width: 100%;
                            font-weight: bold;
                        }
                        .impression-section {
                            margin: 30px 0;
                        }
                        .impression-section strong {
                            font-weight: bold;
                        }
                        .remarks-section {
                            margin: 30px 0;
                        }
                        .remarks-section strong {
                            font-weight: bold;
                        }
                        .disclaimer {
                            margin: 40px 0;
                            font-style: italic;
                            text-align: justify;
                        }
                        .signature-section {
                            text-align: right;
                            margin-top: 80px;
                            margin-bottom: 60px;
                        }
                        .signature-section p {
                            margin: 10px 0;
                            font-size: 12pt;
                        }
                        .doctor-info {
                            margin-top: 40px;
                            font-weight: bold;
                            font-size: 12pt;
                        }
                        .footer-note {
                            text-align: left;
                            margin-top: 60px;
                            font-weight: bold;
                            color: #000;
                            font-size: 11pt;
                        }
                        .watermark {
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            font-size: 60pt;
                            color: rgba(0,0,0,0.08);
                            z-index: -1;
                            pointer-events: none;
                            font-weight: bold;
                            text-align: center;
                            line-height: 1.2;
                        }
                        @@media print {
                            body { 
                                margin: 0; 
                                padding: 0;
                            }
                            .certificate-container { 
                                border: none; 
                                padding: 0.75in;
                                max-width: none;
                                width: 100%;
                            }
                            .watermark {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="watermark">SANG LUNGSOD NG CALOOCAN<br>KASAYSAYAN<br>PILIPINAS 1982</div>
                    <div class="certificate-container">
                        <div class="certificate-header">
                            <h4>BRGY. 161 BAESA HEALTH CENTER</h4>
                            <p>356, ROSE CALOOCAN CITY</p>
                            <p>baesahealthcenter2021@gmail.com</p>
                            <h3>MEDICAL CERTIFICATE</h3>
                            <div class="date-section">
                                DATE: <span class="filled-text-short">${certificateDate}</span>
                            </div>
                        </div>
                        
                        <div class="certificate-body">
                            <p><strong>To whom it may concern:</strong></p>
                            
                            <p>This is to certify that I have seen and examined</p>
                            <div class="filled-text-long">${patientName}</div>
                            
                            <p>, <span class="filled-text-short">${patientAge}</span> year old due to</p>
                            <div class="filled-text-long">${reason || ''}</div>
                            
                            <div class="impression-section">
                                <p><strong>Impression:</strong></p>
                                <div class="filled-text-long">${impression || ''}</div>
                            </div>
                            
                            <div class="remarks-section">
                                <p><strong>Remarks:</strong></p>
                                <div class="filled-text-long">${remarks || ''}</div>
                            </div>
                            
                            <div class="disclaimer">
                                <p>This certification is being issued upon the request of the patient for whatever purpose it may serve except for medico-legal purposes.</p>
                            </div>
                            
                            <div class="signature-section">
                                <p>Respectfully yours,</p>
                                <div class="doctor-info">
                                    <p><strong>${doctorName}</strong></p>
                                    <p>${doctorTitle}</p>
                                </div>
                            </div>
                            
                            <div class="footer-note">
                                <p><strong>NOT VALID WITHOUT ORIGINAL STAMP</strong></p>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Write the HTML to the print window
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for the content to load, then print
            printWindow.onload = function() {
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
} 